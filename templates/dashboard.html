{% extends "base.html" %}
{% block title %}Dashboard - {{ projet.nom }}{% endblock %}

{% block content %}
<div class="container mt-4">

    <h1 class="mb-4">Dashboard : {{ projet.nom }}</h1>

    <div class="mb-3 d-flex gap-2">
        <a class="btn btn-secondary" href="{{ url_for('index') }}">← Retour aux projets</a>
        <a class="btn btn-primary" href="{{ url_for('liste_tests', projet_id=projet.id) }}">Voir tous les tests</a>
    </div>

    <!-- KPI -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card text-white bg-dark mb-3">
                <div class="card-body text-center">
                    <h6>Total Tests</h6>
                    <h3>{{ total }}</h3>
                </div>
            </div>
        </div>

        <div class="col-md-2">
            <div class="card text-white bg-success mb-3">
                <div class="card-body text-center">
                    <h6>Validés</h6>
                    <h3>{{ valides }}</h3>
                </div>
            </div>
        </div>

        <div class="col-md-2">
            <div class="card text-white bg-warning mb-3">
                <div class="card-body text-center">
                    <h6>En cours</h6>
                    <h3>{{ en_cours }}</h3>
                </div>
            </div>
        </div>

        <div class="col-md-2">
            <div class="card text-white bg-danger mb-3">
                <div class="card-body text-center">
                    <h6>KO</h6>
                    <h3>{{ ko }}</h3>
                </div>
            </div>
        </div>

        <div class="col-md-2">
            <div class="card text-white bg-danger mb-3">
                <div class="card-body text-center">
                    <h6>Critiques KO</h6>
                    <h3>{{ critiques_ko }}</h3>
                </div>
            </div>
        </div>

        <div class="col-md-2">
            <div class="card text-white bg-info mb-3">
                <div class="card-body text-center">
                    <h6>Non testés</h6>
                    <h3>{{ non_testes }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Progression globale -->
    <div class="card mb-4">
        <div class="card-body">
            <h5>Avancement global : {{ pourcentage_global }}%</h5>
            <div class="progress" style="height:25px;">
                <div class="progress-bar bg-primary"
                     role="progressbar"
                     style="width: {{ pourcentage_global }}%;"
                     aria-valuenow="{{ pourcentage_global }}"
                     aria-valuemin="0"
                     aria-valuemax="100">
                    {{ pourcentage_global }}%
                </div>
            </div>
        </div>
    </div>

    <!-- Graphiques -->
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="text-center">Répartition par statut</h5>
                    <canvas id="pieStatus"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="text-center">Répartition par module</h5>
                    <canvas id="pieModules"></canvas>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const ctxStatus = document.getElementById('pieStatus').getContext('2d');
new Chart(ctxStatus, {
    type: 'pie',
    data: {
        labels: ['Validé', 'En cours', 'KO', 'Non testé'],
        datasets: [{
            data: [{{ valides }}, {{ en_cours }}, {{ ko }}, {{ non_testes }}],
            backgroundColor: [
                '#28a745',
                '#ffc107',
                '#dc3545',
                '#6c757d'
            ]
        }]
    },
    options: {
        responsive: true,
        plugins: { legend: { position: 'bottom' } }
    }
});

const ctxModules = document.getElementById('pieModules').getContext('2d');
new Chart(ctxModules, {
    type: 'pie',
    data: {
        labels: [{% for m in stats_modules %}'{{ m.nom }}',{% endfor %}],
        datasets: [{
            data: [{% for m in stats_modules %}{{ m.total }},{% endfor %}],
            backgroundColor: [
                {% for m in stats_modules %}
                'hsl({{ loop.index0 * 60 }}, 70%, 60%)',
                {% endfor %}
            ]
        }]
    },
    options: {
        responsive: true,
        plugins: { legend: { position: 'bottom' } }
    }
});
</script>

{% endblock %}